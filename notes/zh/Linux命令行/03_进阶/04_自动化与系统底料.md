# 🤖 自动化与系统底料 (Automation & System Limits)

## 0. Shell 脚本编程基础 (Scripting Basics)
在配置定时任务前，你需要理解 Shell 脚本的核心语法。

### 💡 核心语法速记
- **变量**：`name="Linux"` (等号两边不能有空格)。引用时用 `$name` 或 `${name}`。
- **条件判断**：
  ```bash
  if [ "$status" = "OK" ]; then
      echo "Success"
  else
      echo "Failed"
  fi
  ```
  **💡 常用判断条件 (Cheat Sheet)**：
  | 类型 | 符号 | 含义 |
  | :--- | :--- | :--- |
  | **文件** | `[ -f file ]` | 文件是否存在且为普通文件 |
  | | `[ -d dir ]` | 目录是否存在 |
  | | `[ -s file ]` | 文件存在且长度大于 0 (不为空) |
  | **字符串** | `[ -z "$var" ]` | 字符串为空 (长度为 0) |
  | | `[ -n "$var" ]` | 字符串不为空 |
  | | `[ "$a" = "$b" ]` | 两字符串相等 |
  | **数值** | `[ $n -eq 10 ]` | 等于 (Equal) |
  | | `[ $n -ne 10 ]` | 不等于 (Not Equal) |
  | | `[ $n -gt 10 ]` | 大于 (Greater Than) |
  | | `[ $n -lt 10 ]` | 小于 (Less Than) |

- **循环**：
  ```bash
  for file in $(ls *.log); do
      mv "$file" "${file}.bak"
  done
  ```
- **特殊变量**：
  - `$0`：脚本名 | `$1-$9`：第1-9个参数 | `$@`：所有参数 | `$?`：上个命令执行结果 (0为成功)。

### 🚀 生产级万能脚本模板
创建一个脚本（如 `run.sh`）时，建议以此开头：
```bash
#!/bin/bash
# 脚本功能：示例模板

# 1. 脚本防弹衣：-e(报错即退), -u(未定义变量报错), -o pipefail(管道失败报错)
set -euo pipefail

# 2. 获取脚本所在目录（处理路径问题的终极方案）
CUR_DIR=$(cd $(dirname $0); pwd)

# 3. 逻辑开始
echo "当前脚本路径: $CUR_DIR"
# ... 你的代码 ...
```

## 1. Crontab - 定时任务 (自动化核心)
Linux 的“闹钟”，让系统在指定时间自动运行脚本。

- **核心命令**：
  - `crontab -e`：编辑当前用户的定时任务。
  - `crontab -l`：列出当前所有任务。
  - `crontab -r`：删除所有任务 (慎用！建议用 `-e` 注释掉)。

- **语法逻辑 (5 个星号)**：
  `* * * * * command`
  (分 时 日 月 周)
  - `0 2 * * * /path/backup.sh`：每天凌晨 2 点备份。
  - `*/15 * * * *`：每 15 分钟运行一次。

- **💡 避坑指南**：
  1. **路径问题**：Crontab 环境没有你的 PATH 变量。
     - **方案 A (简单)**：使用绝对路径，如 `/usr/bin/python3`。
     - **方案 B (优雅)**：在 crontab 文件第一行手动定义 PATH，如：
       `PATH=/usr/local/bin:/usr/bin:/bin`
  2. **末尾重定向日志**：`* * * * * /cmd >> /tmp/cron.log 2>&1`，否则报错你根本看不见。

---

## 2. 硬件与系统信息
当别人问你“这服务器什么配置”时，用这几招：
- `lscpu`：查看 CPU 核心数、架构、主频。
- `lsusb` / `lspci`：查看外接设备和 PCI 设备（显卡、网卡）。
- `free -h`：查看内存（不仅看 Total，更要看 **Available**）。

---

## 3. ulimit - 系统资源限制
**场景**：程序报错 "Too many open files" 或 "Out of memory"。
- `ulimit -a`：显示当前用户的所有资源限制。
- `ulimit -n 65535`：临时增加最大打开文件数。
- **永久修改**：需编辑 `/etc/security/limits.conf`。
  - **范例 (末尾添加)**：
    ```text
    * soft nofile 65535
    * hard nofile 65535
    ```
- **生效**：修改后需重新登录 Shell。

---

## 4. 环境变量深度技巧
- **`env`**：列出当前所有环境变量。
- **`export PATH=$PATH:/your/path`**：将新路径加入环境变量。

### 💡 核心：配置文件加载顺序 (生命周期)
Linux 启动时会按特定顺序读取配置文件，理解这个顺序能解决“为什么我的配置没生效”的问题。

1. **Login Shell** (如：SSH 远程登录、`su -l` 切换用户)
   - 加载顺序：`/etc/profile` -> `~/.bash_profile` (或 `~/.bash_login`, `~/.profile`) -> **最后才加载 `~/.bashrc`**。
2. **Non-login Shell** (如：在图形界面打开终端、直接执行脚本)
   - 加载顺序：**直接读取 `~/.bashrc`**。

- **最佳实践**：
  - **个人配置**：永远写在 `~/.bashrc` 中。
  - **全局配置**：写在 `/etc/profile.d/my_env.sh` (比直接改 `/etc/profile` 更易维护)。
  - **生效命令**：修改后必须执行 `source ~/.bashrc` 才能在当前终端立即生效。
