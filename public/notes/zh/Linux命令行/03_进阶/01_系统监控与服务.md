# 📊 系统监控与服务 (Monitoring & Services)

## 1. ps / top / htop / fastfetch - 进程与系统监控

- **`ps aux | grep nginx`**：**最常用的组合**。查看 nginx 是否在运行，并找到它的 PID。
- `ps -ef`：标准格式查看所有进程。
- `top`：实时显示系统资源使用情况。
  - **💡 内部快捷键**：
    - `P`：按 **CPU** 占用排序。
    - `M`：按**内存**占用排序。
    - `1`：切换显示每个 CPU 核心的详情。
    - `k`：直接在 top 中杀死进程 (需输入 PID)。
    - `q`：退出。
- `htop`：更直观的交互式进程监控，支持鼠标操作。
- `fastfetch`：现代化的系统信息展示工具，查看发行版、内核等。

---

## 2. kill / pkill / killall - 终止进程

- `kill PID`：发送终止信号给指定 PID。
- **💡 核心：理解信号 (Signals)**
  - **`kill -15 PID` (SIGTERM)**：**优雅终止** (默认)。给程序写遗言的时间 (如保存文件、关闭数据库连接)。
  - **`kill -9 PID` (SIGKILL)**：**暴力杀死**。强制立即退出，可能导致数据丢失。**只有当程序卡死且 -15 无效时才使用**。
- **`pkill 进程名`**：按名称匹配并杀死进程。
- **`killall 进程名`**：杀死所有同名进程。

---

## 3. df / du / ncdu - 存储管理
- `df -h`：查看磁盘分区剩余空间。
- **`du -sh * | sort -h`**：查看当前目录下每个文件夹的大小并排序。
> 💡 **Pro Tip**: 尝试使用 **`dust`** 替代 `du`，提供更直观的树状磁盘占用图。
- **`ncdu`**：交互式磁盘占用分析工具，比 `du` 更直观方便。
- `lsblk`：查看硬盘挂载点及分区结构。

---

### 🚀 磁盘生命周期实战：从新硬盘到挂载使用

当你插上一块新硬盘（假设识别为 `/dev/sdb`）时，需要经历以下三步：

#### 第一步：分区 (Partition)
- **`sudo fdisk /dev/sdb`**：进入交互式分区工具。
  - 输入 `n` 创建新分区。
  - 输入 `p` 选择主分区。
  - 输入 `w` 保存并退出。
- *如果是大于 2TB 的硬盘*：请使用 `sudo parted /dev/sdb`。

#### 第二步：格式化 (Format)
- **`sudo mkfs.ext4 /dev/sdb1`**：将刚才创建的分区格式化为 ext4 文件系统。

#### 第三步：挂载 (Mount)
- **临时挂载**：`sudo mount /dev/sdb1 /mnt/data`
- **永久挂载 (开机自动挂载)**：
  1. 获取 UUID：`sudo blkid /dev/sdb1`
  2. 编辑配置：`sudo vi /etc/fstab`
  3. 添加一行：`UUID=xxx /mnt/data ext4 defaults 0 2`
  4. 测试配置：**`sudo mount -a`** (如果在重启前不执行此命令测试，fstab 写错可能导致系统无法启动！)。

- **解重载与卸载**：
  - `umount -l /mnt/data`：**懒卸载**，解决 "device is busy" 无法卸载的问题。

---

## 4. 底层性能与日志
- `iostat -x 1`：每秒刷新一次，查看磁盘 I/O 瓶颈。
  - **看什么**：如果 **`%iowait`** 很高，说明 CPU 在等待磁盘读写完成，磁盘太慢拖累了系统。
- `vmstat 1`：查看系统内存、交换分区、CPU 的整体压力。
  - **看什么**：关注 `si` (swap in) 和 `so` (swap out)，如果数值持续大于 0，说明物理内存不足，正在频繁使用交换分区。
- **`strace -p PID`**：**系统调用追踪**。当一个程序突然卡死或无法打开文件时，用它能看到程序最后在尝试进行什么底层操作 (如：一直在尝试读取某个不存在的配置文件)。
- `dmesg -T`：查看内核环形缓冲区日志 (如硬件故障、OOM 杀掉的进程)。
- **💡 稳健的日志追踪**：
  - `tail -F /var/log/nginx/access.log`
  - **注意**：用大写的 **`-F`** 而不是 `-f`。当日志文件因“日志轮转”（Rotate）被重新生成时，`-F` 能自动跟踪新文件，而 `-f` 会直接失效。

---

## 5. 网络连接查看 (ss vs netstat)
在很多现代最小化安装的 Linux 中，`netstat` 默认是不预装的，因此必须学会使用 **`ss`**。

- **`ss -tulpn`**：查看当前系统监听的所有端口（t:TCP, u:UDP, l:Listen, p:Process, n:Numeric）。
- `ss -s`：显示网络统计摘要。
- `ping` / `traceroute`：测试网络连通性与路由路径。

---

## 6. systemctl - 服务管理 (现代 Linux 核心)
在现代 Linux (如 Ubuntu 18.04+, CentOS 7+) 中，`systemd` 是管理服务的标准工具。

- **sudo systemctl status nginx**：**查看状态** (排查故障第一步)
  - `sudo systemctl enable nginx`：设置开机自启
  - `sudo systemctl disable nginx`：禁用开机自启
- **💡 优雅地修改配置：systemctl edit**
  - **传统做法**：直接改 `/lib/systemd/system/xxx.service`。*缺点*：软件更新后会被覆盖。
  - **优雅做法**：`sudo systemctl edit nginx`。
    - 它会创建一个“补丁”文件（Drop-in file）。
    - 你只需写入要覆盖的部分（如 `ExecStart=`），系统会自动合并。
    - 运行 `sudo systemctl daemon-reload` 即可生效。

---

## 6. journalctl - 系统日志管家 (排障核心)
`systemd` 统一管理了所有服务的日志，`journalctl` 是唯一的查询入口。

- **实时追踪**：
  - `journalctl -f`：类似 `tail -f`，查看最新产生的日志。
  - `journalctl -u nginx.service -f`：**实时追踪特定服务**。
- **时间过滤**：
  - `journalctl -b`：**只看本次启动后**产生的日志 (常用)。
  - `journalctl --since "1 hour ago"`：查看最近一小时。
- **错误排查**：
  - `journalctl -p err -b`：只查看本次启动后的**错误 (Error) 级别**以上的日志。
  - **`journalctl -xe`**：查看最后几行并附带错误解释。
    - **`-x` (catalog)**：增加解释性文本，告诉你错误可能的原因或相关的系统帮助文档。
    - **`-e` (pager-end)**：直接跳转到日志末尾（最新的地方），省去翻页麻烦。
- **💡 救火绝技：清理日志空间**
  - 当磁盘被日志塞满时：
  - `journalctl --disk-usage`：查看占用空间。
  - `sudo journalctl --vacuum-time=7d`：删除 7 天前的旧日志。
  - `sudo journalctl --vacuum-size=500M`：强制将日志压缩到 500MB 以内。

---

## 7. 任务管理与后台运行

- `&`：在命令末尾添加，使命令在后台运行 (如 `python server.py &`)
- `Ctrl + Z`：挂起当前前台任务到后台 (暂停状态)
- `jobs`：查看当前终端的所有后台任务
- `fg %n`：将编号为 n 的任务调回前台 (foreground)
- `bg %n`：让后台挂起的任务继续在后台运行 (background)
- `nohup 命令 &`：让命令在退出终端后继续运行 (No Hang Up)
- `disown %n`：将后台任务与终端解绑，效果类似 `nohup`

---

## 8. tmux - 终端复用器 (生产力之王)
`tmux` 解决两大痛点：1. 远程连接断开导致任务中断；2. 单个窗口不够用。

- **基础管理**：
  - `tmux new -s work`：创建一个名为 "work" 的新会话
  - `tmux detach` (或快捷键 `Ctrl+B, d`)：退出会话，但**程序在后台继续运行**
  - `tmux ls`：列出所有后台会话
  - `tmux a -t work`：重新连接 (Attach) 到 "work" 会话
  - `tmux kill-session -t work`：彻底关闭会话

- **常用快捷键** (先按前缀键 **`Ctrl + B`**，松开后再按功能键):
  - **分屏**：`%` 左右分屏，`"` 上下分屏
  - **导航**：`方向键` 在分屏间切换；`z` **最大化/还原**当前分屏 (神技)
  - **窗口**：`c` 创建新窗口，`n/p` 切换窗口，`w` 列表选择窗口
  - **滚动**：`[` 进入复制模式，可以用方向键翻页，按 `q` 退出

> 💡 **Pro Tip: 开启鼠标支持**
> 在 `~/.tmux.conf` 中加入 `set -g mouse on`，你就可以直接用鼠标点击切换分屏、拖动大小和滚动翻页了。

---

## 9. watch - 周期性执行
- `watch -n 1 'ls -lh file.txt'`：每秒观察文件大小变化。
- `watch -d 'netstat -tulpn'`：监控端口状态并**高亮变化**。

---

## 🚀 性能排查全家桶：从发现到定位

当服务器出现拥堵或异常时，建议遵循以下递进逻辑进行排查：

1. **第一步：看大局 (`top` / `htop`)**
   - 确认是哪个资源（CPU、内存、I/O）遇到了瓶颈。
   - 找到占用最高的进程 PID。

2. **第二步：查细节 (`iostat` / `vmstat`)**
   - 如果 CPU 负载高但进程占用不高，看 `iowait`（磁盘慢）或 `si/so`（内存交换）。
   - `iostat -x 1`：检查磁盘吞吐与延迟。

3. **第三步：看网络与连接 (`ss` / `netstat`)**
   - `ss -tulpn`：确认进程是否在正常监听端口。
   - 检查是否有大量异常连接占用句柄。

4. **第四步：看资源占用 (`lsof`)**
   - `lsof -p PID`：看这个进程打开了哪些文件、加载了哪些库。
   - `lsof -i :port`：确认谁占用了关键端口。

5. **第五步：终极侦探 (`strace`)**
   - `strace -p PID`：观察进程正在进行的系统调用。
   - **场景**：程序没报错但没响应，通过 strace 发现它一直卡在 `read` 某个配置文件上。

6. **第六步：翻旧账 (`journalctl` / `dmesg`)**
   - `dmesg -T`：查看是否有硬件故障或 OOM (内存溢出) 杀掉进程的记录。
   - `journalctl -u 服务名 -xe`：查看服务启动失败的具体报错。
